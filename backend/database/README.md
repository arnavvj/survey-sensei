# Survey Sensei - Database Setup

## Overview

PostgreSQL database schema for Survey Sensei's mock data engineering framework. Supports realistic e-commerce data generation with AI-powered mock data agents.

## Quick Setup

### 1. Generate SQL

```bash
cd backend
python database/init/apply_migrations.py
```

This creates `backend/database/_combined_migrations.sql` with:
- DROP TABLE statements (master reset)
- All table creation statements
- Triggers and functions
- Row Level Security policies

### 2. Run in Supabase

1. Go to [Supabase SQL Editor](https://supabase.com/dashboard/project/_/sql/new)
2. Paste entire contents of `_combined_migrations.sql`
3. Click "Run"

**WARNING:** This will DROP all existing tables and data!

### 3. Load Mock Data

```bash
# Start backend server
python -m backend.main

# Call mock data endpoint from frontend or directly
curl -X POST http://localhost:8000/api/mock-data \
  -H "Content-Type: application/json" \
  -d '{"asin": "B07ZPKN6YR", "num_scenarios": 3}'
```

**Important**: The database is automatically cleaned before each data generation run. This ensures:
- No duplicate main users from previous test runs
- Fresh data environment for each scenario
- All previous products, users, transactions, and reviews are deleted
- Survey sessions are also cleared

## Database Schema

### Core Tables (Mock Data System)

```
products â”€â”€â”
           â”œâ”€â”€> transactions â”€â”€> reviews
users â”€â”€â”€â”€â”€â”˜
```

#### 1. **products** - Product catalog from Amazon
- Fetched via RapidAPI Real-Time Amazon Data API
- Contains: ASIN, title, brand, price, photos, ratings
- `is_mock`: Distinguishes real (RapidAPI) vs generated products
- **Vector embeddings automatically generated** using OpenAI `text-embedding-3-small`

**Key Fields:**
```sql
item_id VARCHAR(20) PRIMARY KEY  -- ASIN
title TEXT NOT NULL
brand VARCHAR(255)
price DECIMAL(12, 2)
star_rating DECIMAL(3, 2)
photos JSONB
is_mock BOOLEAN DEFAULT false
embeddings vector(1536)  -- âœ… Auto-populated during data generation
```

**Embedding Composition**: item_id, title, brand, description, star_rating, num_ratings, category, price

#### 2. **users** - User personas
- Generated by `MOCK_USR_MINI_AGENT` with realistic demographics
- Main user (real) + mock users for data diversity
- Demographic fields: age, location, gender
- **Vector embeddings automatically generated** using OpenAI `text-embedding-3-small`

**Key Fields:**
```sql
user_id UUID PRIMARY KEY
user_name VARCHAR(255)
email_id VARCHAR(255) UNIQUE
age INTEGER
base_location VARCHAR(255)
base_zip VARCHAR(20)
gender VARCHAR(50)
is_main_user BOOLEAN DEFAULT false  -- true = survey target, false = generated mock user
embeddings vector(1536)  -- âœ… Auto-populated during data generation
```

**Embedding Composition**: user_name, age, base_location, base_zip, gender

#### 3. **transactions** - Purchase records
- Generated by `MOCK_TRX_MINI_AGENT`
- Links users to products with realistic temporal patterns
- Auto-computed discount percentage
- Prevents duplicate purchases (e-commerce sparsity)

**Key Fields:**
```sql
transaction_id UUID PRIMARY KEY
item_id VARCHAR(20) REFERENCES products
user_id UUID REFERENCES users
order_date TIMESTAMP
delivery_date TIMESTAMP
original_price DECIMAL(12, 2)
retail_price DECIMAL(12, 2)
discount_percentage DECIMAL(5, 2) GENERATED
transaction_status VARCHAR(20)
is_mock BOOLEAN DEFAULT false
```

#### 4. **reviews** - Product reviews
- Generated by `MOCK_RVW_MINI_AGENT`
- Mix of real (RapidAPI scraped) + AI-generated reviews
- One review per transaction (enforced constraint)
- Tracks review source and authorship
- **Vector embeddings automatically generated** using OpenAI `text-embedding-3-small`

**Key Fields:**
```sql
review_id UUID PRIMARY KEY
item_id VARCHAR(20) REFERENCES products
user_id UUID REFERENCES users
transaction_id UUID REFERENCES transactions
review_title VARCHAR(500)
review_text TEXT NOT NULL
review_stars INTEGER  -- 1-5
source VARCHAR(20)  -- 'rapidapi', 'agent_generated', 'user_submitted'
manual_or_agent_generated VARCHAR(20)  -- 'manual', 'agent'
embeddings vector(1536)  -- âœ… Auto-populated during data generation
```

**Embedding Composition**: item_id, user_id, transaction_id, timestamp, review_title, review_text, review_stars

**Source vs Manual/Agent Distinction:**
- `source`: Where the review came from (RapidAPI, agent, user)
- `manual_or_agent_generated`: Who wrote the text (human, AI)

### Survey Tables (Future - Subject to Change)

#### 5. **survey** - Survey questions (âš ï¸ In Development)
- Dynamically generated questions for user surveys
- Schema will evolve as survey framework develops

#### 6. **survey_sessions** - Session tracking (âš ï¸ In Development)
- Tracks survey progress and conversation state
- Schema will evolve as survey framework develops

## Table Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  products   â”‚  Real products from RapidAPI + similar products (generated)
â”‚  (ASIN)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:N
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚transactions â”‚  N:1  â”‚    users    â”‚  Real user + mock users (generated)
â”‚             â”œâ”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:1
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   reviews   â”‚  Real reviews (RapidAPI) + generated reviews
â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Data Flow:**
1. Main product fetched from RapidAPI (real)
2. Similar products generated by MOCK_PDT_MINI_AGENT
3. Main user provided, mock users generated by MOCK_USR_MINI_AGENT
4. Transactions created by MOCK_TRX_MINI_AGENT (realistic patterns)
5. Reviews created by MOCK_RVW_MINI_AGENT (mix of real + generated)

## Mock Data Architecture

### Data Generation Pipeline

```
User Input (Form) â†’ Orchestrator â†’ Agents â†’ Database
                         â”‚
                    STEP 1: Cleanup (delete all existing data)
                    STEP 2: Build scenario configuration
                    STEP 3: Fetch from RapidAPI
                    STEP 4: Generate mock data (WITHOUT embeddings)
                         â”œâ”€> MOCK_PDT_MINI_AGENT (similar products)
                         â”œâ”€> MOCK_USR_MINI_AGENT (user personas)
                         â”œâ”€> MOCK_TRX_MINI_AGENT (transactions)
                         â””â”€> MOCK_RVW_MINI_AGENT (reviews)
                    STEP 5: Batch generate embeddings (OPTIMIZED)
                         â”œâ”€> Products: 100 per batch
                         â”œâ”€> Users: 100 per batch
                         â””â”€> Reviews: 100 per batch
                    STEP 6: Insert into database (with embeddings)
```

**Important**: Database cleanup happens BEFORE data generation (STEP 1) to ensure a fresh environment for each test run.

### Realism Features

1. **E-commerce Sparsity**: Users don't buy duplicate products
2. **Temporal Patterns**: Order â†’ Delivery dates are realistic
3. **Review Distribution**: Configurable sentiment spread (good/neutral/bad)
4. **Price Handling**: Fallback for products with missing prices
5. **Data Provenance**: Every record tracks if it's real or generated

### Data Provenance Columns

**Products:**
- `is_mock = false`: Real product from RapidAPI
- `is_mock = true`: Generated similar product

**Users:**
- `is_main_user = true`: Main user from form submission (survey target)
- `is_main_user = false`: Generated mock user

**Transactions:**
- `is_mock = false`: Main user's transaction
- `is_mock = true`: Mock user's transaction (derived from user's `is_main_user` status)

## Database Features

### Auto-Generated Fields

- **Timestamps**: `created_at`, `updated_at` (auto-managed by triggers)
- **Discount Percentage**: Computed from `(original_price - retail_price) / original_price * 100`

### Constraints

- Foreign keys with CASCADE delete
- Check constraints: price â‰¥ 0, stars 1-5, age 18-120
- Unique constraints: one review per transaction
- Enum constraints: source, status, gender fields

### Indexes

- Primary keys (UUID, ASIN)
- Foreign keys (for joins)
- Vector embeddings (IVFFlat - reserved for future use)
- Frequently queried fields (brand, category, stars, source)

### Triggers

1. **update_updated_at_column()**: Auto-updates `updated_at` on all tables
2. **Review count sync**: Updates `products.review_count` when reviews added/removed

## File Structure

```
backend/database/
â”œâ”€â”€ _combined_migrations.sql       # Generated master reset script
â”œâ”€â”€ README.md                      # This file
â”œâ”€â”€ supabase_client.py            # Python Supabase client
â”œâ”€â”€ init/
â”‚   â””â”€â”€ apply_migrations.py       # Generates combined SQL
â”œâ”€â”€ migrations/                   # Individual migration files
â”‚   â”œâ”€â”€ 001_enable_extensions.sql
â”‚   â”œâ”€â”€ 002_create_products_table.sql
â”‚   â”œâ”€â”€ 003_create_users_table.sql
â”‚   â”œâ”€â”€ 004_create_transactions_table.sql
â”‚   â”œâ”€â”€ 005_create_reviews_table.sql
â”‚   â”œâ”€â”€ 006_create_survey_table.sql      # âš ï¸ Subject to change
â”‚   â”œâ”€â”€ 007_create_survey_sessions_table.sql  # âš ï¸ Subject to change
â”‚   â”œâ”€â”€ 008_create_triggers.sql
â”‚   â”œâ”€â”€ 009_enable_row_level_security.sql
â”‚   â””â”€â”€ 010_add_conversation_history_column.sql
â””â”€â”€ functions/
    â””â”€â”€ match_products.sql        # Vector similarity search (reserved)
```

## Verification

### Check Tables Created

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

Expected: `products`, `reviews`, `survey`, `survey_sessions`, `transactions`, `users`

### Check Mock Data

```sql
-- Count real vs mock products
SELECT is_mock, COUNT(*) FROM products GROUP BY is_mock;

-- Count main user vs mock users
SELECT is_main_user, COUNT(*) FROM users GROUP BY is_main_user;

-- Review source distribution
SELECT source, manual_or_agent_generated, COUNT(*)
FROM reviews
GROUP BY source, manual_or_agent_generated;
```

## Row Level Security (RLS)

Current policies enable public read for products, user-scoped access for personal data.

**For development, you may disable RLS:**

```sql
ALTER TABLE products DISABLE ROW LEVEL SECURITY;
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE transactions DISABLE ROW LEVEL SECURITY;
ALTER TABLE reviews DISABLE ROW LEVEL SECURITY;
```

**WARNING:** Never disable RLS in production!

## Troubleshooting

### Tables not appearing
- Ensure pgvector extension is enabled: `CREATE EXTENSION vector;`
- Check Supabase logs: Project Settings â†’ Database â†’ Logs

### Mock data generation fails
- Verify RapidAPI key in `.env.local`
- Check RapidAPI rate limits
- Review agent logs for specific errors

### Price showing $0.00
- Some Amazon products hide prices ("See price in cart")
- Transaction agent generates fallback prices ($19.99-$149.99)
- This is expected behavior

## Database Cleanup

The `cleanup_mock_data()` function in [supabase_client.py](supabase_client.py:95-137) deletes ALL data from the database before each test run:

**What Gets Deleted:**
1. All survey sessions
2. All reviews (real + generated)
3. All transactions
4. All users (including previous main users)
5. All products (including previous main products)

**Why This Matters:**
- Prevents duplicate main users from accumulating across test runs
- Ensures each scenario starts with a clean slate
- Maintains data integrity and consistency

**When It Runs:**
- Automatically at STEP 1 of the mock data pipeline
- Before any new data is generated or fetched

## Logging

The backend uses structured logging for better readability:

**Backend Logging** ([backend/utils/logger.py](../utils/logger.py)):
- Colored console output with ANSI codes
- Emojis for quick visual scanning
- Minimal verbosity (single-line logs)
- Example: `âœ… GET /api/mock-data â†’ 200 (1234ms)`

**Frontend Logging** ([frontend/lib/logger.ts](../../frontend/lib/logger.ts)):
- CSS-styled console output
- Category-based logging (api, agent, state, etc.)
- Development-only (suppressed in production)
- Example: `ğŸ¤– Generating review options`

**Log Output Example:**
```
âœ… Cleanup: 156 rows deleted
âœ… Database: 9p 21u 156t 125r inserted
âœ… POST /api/mock-data â†’ 200 (4532ms)
```

Where `9p` = 9 products, `21u` = 21 users, `156t` = 156 transactions, `125r` = 125 reviews

## Future Enhancements

- Survey table schema finalization
- Advanced semantic search using pgvector
- Sentiment analysis integration
- Real-time vector similarity search optimization
