# Survey Sensei - Database Setup

## Overview

PostgreSQL database schema for Survey Sensei's mock data engineering framework. Supports realistic e-commerce data generation with AI-powered mock data agents.

## Quick Setup

### 1. Generate SQL

```bash
cd backend
python database/init/apply_migrations.py
```

This creates `backend/database/_combined_migrations.sql` with:
- DROP TABLE statements (master reset)
- All table creation statements
- Triggers and functions
- Row Level Security policies

### 2. Run in Supabase

1. Go to [Supabase SQL Editor](https://supabase.com/dashboard/project/_/sql/new)
2. Paste entire contents of `_combined_migrations.sql`
3. Click "Run"

**WARNING:** This will DROP all existing tables and data!

### 3. Load Mock Data

```bash
# Start backend server
python -m backend.main

# Call mock data endpoint from frontend or directly
curl -X POST http://localhost:8000/api/mock-data \
  -H "Content-Type: application/json" \
  -d '{"asin": "B07ZPKN6YR", "num_scenarios": 3}'
```

## Database Schema

### Core Tables (Mock Data System)

```
products ──┐
           ├──> transactions ──> reviews
users ─────┘
```

#### 1. **products** - Product catalog from Amazon
- Fetched via RapidAPI Real-Time Amazon Data API
- Contains: ASIN, title, brand, price, photos, ratings
- `is_mock`: Distinguishes real (RapidAPI) vs generated products
- Vector embeddings for semantic search (reserved for future use)

**Key Fields:**
```sql
item_id VARCHAR(20) PRIMARY KEY  -- ASIN
title TEXT NOT NULL
brand VARCHAR(255)
price DECIMAL(12, 2)
star_rating DECIMAL(3, 2)
photos JSONB
is_mock BOOLEAN DEFAULT false
embeddings vector(1536)  -- Reserved
```

#### 2. **users** - User personas
- Generated by `MOCK_USR_MINI_AGENT` with realistic demographics
- Main user (real) + mock users for data diversity
- Demographic fields: age, location, credit_score, spending patterns

**Key Fields:**
```sql
user_id UUID PRIMARY KEY
user_name VARCHAR(255)
email_id VARCHAR(255) UNIQUE
age INTEGER
base_location VARCHAR(255)
credit_score INTEGER
avg_monthly_expenses DECIMAL(12, 2)
is_mock BOOLEAN DEFAULT false
embeddings vector(1536)  -- Reserved
```

#### 3. **transactions** - Purchase records
- Generated by `MOCK_TRX_MINI_AGENT`
- Links users to products with realistic temporal patterns
- Auto-computed discount percentage
- Prevents duplicate purchases (e-commerce sparsity)

**Key Fields:**
```sql
transaction_id UUID PRIMARY KEY
item_id VARCHAR(20) REFERENCES products
user_id UUID REFERENCES users
order_date TIMESTAMP
delivery_date TIMESTAMP
original_price DECIMAL(12, 2)
retail_price DECIMAL(12, 2)
discount_percentage DECIMAL(5, 2) GENERATED
transaction_status VARCHAR(20)
is_mock BOOLEAN DEFAULT false
```

#### 4. **reviews** - Product reviews
- Generated by `MOCK_RVW_MINI_AGENT`
- Mix of real (RapidAPI scraped) + AI-generated reviews
- One review per transaction (enforced constraint)
- Tracks review source and authorship

**Key Fields:**
```sql
review_id UUID PRIMARY KEY
item_id VARCHAR(20) REFERENCES products
user_id UUID REFERENCES users
transaction_id UUID REFERENCES transactions
review_title VARCHAR(500)
review_text TEXT NOT NULL
review_stars INTEGER  -- 1-5
source VARCHAR(20)  -- 'rapidapi', 'agent_generated', 'user_submitted'
manual_or_agent_generated VARCHAR(20)  -- 'manual', 'agent'
embeddings vector(1536)  -- Reserved
```

**Source vs Manual/Agent Distinction:**
- `source`: Where the review came from (RapidAPI, agent, user)
- `manual_or_agent_generated`: Who wrote the text (human, AI)

### Survey Tables (Future - Subject to Change)

#### 5. **survey** - Survey questions (⚠️ In Development)
- Dynamically generated questions for user surveys
- Schema will evolve as survey framework develops

#### 6. **survey_sessions** - Session tracking (⚠️ In Development)
- Tracks survey progress and conversation state
- Schema will evolve as survey framework develops

## Table Relationships

```
┌─────────────┐
│  products   │  Real products from RapidAPI + similar products (generated)
│  (ASIN)     │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────▼──────┐       ┌─────────────┐
│transactions │  N:1  │    users    │  Real user + mock users (generated)
│             ├───────┤             │
└──────┬──────┘       └─────────────┘
       │
       │ 1:1
       │
┌──────▼──────┐
│   reviews   │  Real reviews (RapidAPI) + generated reviews
│             │
└─────────────┘
```

**Data Flow:**
1. Main product fetched from RapidAPI (real)
2. Similar products generated by MOCK_PDT_MINI_AGENT
3. Main user provided, mock users generated by MOCK_USR_MINI_AGENT
4. Transactions created by MOCK_TRX_MINI_AGENT (realistic patterns)
5. Reviews created by MOCK_RVW_MINI_AGENT (mix of real + generated)

## Mock Data Architecture

### Data Generation Pipeline

```
User Input (ASIN) → Orchestrator → Agents → Database
                         │
                         ├─> MOCK_PDT_MINI_AGENT (similar products)
                         ├─> MOCK_USR_MINI_AGENT (user personas)
                         ├─> MOCK_TRX_MINI_AGENT (transactions)
                         └─> MOCK_RVW_MINI_AGENT (reviews)
```

### Realism Features

1. **E-commerce Sparsity**: Users don't buy duplicate products
2. **Temporal Patterns**: Order → Delivery dates are realistic
3. **Review Distribution**: Configurable sentiment spread (good/neutral/bad)
4. **Price Handling**: Fallback for products with missing prices
5. **Data Provenance**: Every record tracks if it's real or generated

### `is_mock` Column Meaning

- `products.is_mock = false`: Real product from RapidAPI
- `products.is_mock = true`: Generated similar product
- `users.is_mock = false`: Real main user
- `users.is_mock = true`: Generated mock user
- `transactions.is_mock = false`: Main user's transaction
- `transactions.is_mock = true`: Mock user's transaction

## Database Features

### Auto-Generated Fields

- **Timestamps**: `created_at`, `updated_at` (auto-managed by triggers)
- **Discount Percentage**: Computed from `(original_price - retail_price) / original_price * 100`

### Constraints

- Foreign keys with CASCADE delete
- Check constraints: price ≥ 0, stars 1-5, age 18-120
- Unique constraints: one review per transaction
- Enum constraints: source, status, gender fields

### Indexes

- Primary keys (UUID, ASIN)
- Foreign keys (for joins)
- Vector embeddings (IVFFlat - reserved for future use)
- Frequently queried fields (brand, category, stars, source)

### Triggers

1. **update_updated_at_column()**: Auto-updates `updated_at` on all tables
2. **Review count sync**: Updates `products.review_count` when reviews added/removed

## File Structure

```
backend/database/
├── _combined_migrations.sql       # Generated master reset script
├── README.md                      # This file
├── supabase_client.py            # Python Supabase client
├── init/
│   └── apply_migrations.py       # Generates combined SQL
├── migrations/                   # Individual migration files
│   ├── 001_enable_extensions.sql
│   ├── 002_create_products_table.sql
│   ├── 003_create_users_table.sql
│   ├── 004_create_transactions_table.sql
│   ├── 005_create_reviews_table.sql
│   ├── 006_create_survey_table.sql      # ⚠️ Subject to change
│   ├── 007_create_survey_sessions_table.sql  # ⚠️ Subject to change
│   ├── 008_create_triggers.sql
│   ├── 009_enable_row_level_security.sql
│   └── 010_add_conversation_history_column.sql
└── functions/
    └── match_products.sql        # Vector similarity search (reserved)
```

## Verification

### Check Tables Created

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

Expected: `products`, `reviews`, `survey`, `survey_sessions`, `transactions`, `users`

### Check Mock Data

```sql
-- Count real vs mock products
SELECT is_mock, COUNT(*) FROM products GROUP BY is_mock;

-- Count real vs mock users
SELECT is_mock, COUNT(*) FROM users GROUP BY is_mock;

-- Review source distribution
SELECT source, manual_or_agent_generated, COUNT(*)
FROM reviews
GROUP BY source, manual_or_agent_generated;
```

## Row Level Security (RLS)

Current policies enable public read for products, user-scoped access for personal data.

**For development, you may disable RLS:**

```sql
ALTER TABLE products DISABLE ROW LEVEL SECURITY;
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE transactions DISABLE ROW LEVEL SECURITY;
ALTER TABLE reviews DISABLE ROW LEVEL SECURITY;
```

**WARNING:** Never disable RLS in production!

## Troubleshooting

### Tables not appearing
- Ensure pgvector extension is enabled: `CREATE EXTENSION vector;`
- Check Supabase logs: Project Settings → Database → Logs

### Mock data generation fails
- Verify RapidAPI key in `.env.local`
- Check RapidAPI rate limits
- Review agent logs for specific errors

### Price showing $0.00
- Some Amazon products hide prices ("See price in cart")
- Transaction agent generates fallback prices ($19.99-$149.99)
- This is expected behavior

## Future Enhancements

- Vector embeddings population (currently reserved/NULL)
- Survey table schema finalization
- Advanced semantic search using pgvector
- Sentiment analysis integration
